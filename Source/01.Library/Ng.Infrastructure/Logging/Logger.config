<?xml version="1.0" encoding="utf-8" ?>
<nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      autoReload="true"
      throwExceptions="false"
      internalLogLevel="Warn"
      internalLogFile="${basedir}/Logs/nlog-internal.log">

	<!-- 변수 정의 -->
	<variable name="logDirectory" value="${basedir}/Logs" />
	<variable name="archiveDirectory" value="${basedir}/Logs/Archive" />

	<!-- 공통 로그 포맷 (범용적인 형태) -->
	<variable name="defaultLayout"
			  value="${longdate}|${level:uppercase=true:padding=-5}|${logger:shortName=true}|${message}${onexception:inner=${newline}${exception:format=tostring}}" />

	<variable name="detailedLayout"
			  value="${longdate}|${level:uppercase=true:padding=-5}|${processid}|${threadid:padding=3}|${logger:shortName=true}|${callsite:includeNamespace=false:methodName=true}|${message}${onexception:inner=${newline}${exception:format=tostring}}" />

	<targets async="true">
		<!-- 파일 로그: 사이즈(100MB) 및 데일리 롤링 -->
		<target xsi:type="File"
				name="FileLogger"
				fileName="${logDirectory}/${processname}.log"
				layout="${detailedLayout}"
				encoding="utf-8"
				keepFileOpen="true"
				concurrentWrites="false"
				archiveEvery="Day"
				archiveDateFormat="yyyyMMdd"
				archiveNumbering="DateAndSequence"
				archiveAboveSize="104857600"
				maxArchiveFiles="30"
				maxArchiveDays="30"
				archiveFileName="${archiveDirectory}/${processname}.{#}.log" />

		<!-- 에러 전용 파일 로그 -->
		<target xsi:type="File"
				name="ErrorFileLogger"
				fileName="${logDirectory}/${processname}-error.log"
				layout="${detailedLayout}"
				encoding="utf-8"
				keepFileOpen="true"
				concurrentWrites="false"
				archiveEvery="Day"
				archiveDateFormat="yyyyMMdd"
				archiveNumbering="DateAndSequence"
				archiveAboveSize="104857600"
				maxArchiveFiles="30"
				maxArchiveDays="30"
				archiveFileName="${archiveDirectory}/${processname}-error.{#}.log" />

		<!-- 콘솔 로그: 레벨별 색상 지정 -->
		<target xsi:type="ColoredConsole"
				name="ConsoleLogger"
				useDefaultRowHighlightingRules="false"
				layout="${time}|${level:uppercase=true:padding=-5}|${logger:shortName=true}|${message}${onexception:inner= - ${exception:format=message}}">

			<!-- Trace: 어두운 회색 -->
			<highlight-row condition="level == LogLevel.Trace" foregroundColor="DarkGray" />

			<!-- Debug: 회색 -->
			<highlight-row condition="level == LogLevel.Debug" foregroundColor="Gray" />

			<!-- Info: 녹색 -->
			<highlight-row condition="level == LogLevel.Info" foregroundColor="Green" />

			<!-- Warn: 노란색 -->
			<highlight-row condition="level == LogLevel.Warn" foregroundColor="Yellow" />

			<!-- Error: 빨간색 -->
			<highlight-row condition="level == LogLevel.Error" foregroundColor="Red" />

			<!-- Fatal: 흰색 배경에 빨간 글씨 -->
			<highlight-row condition="level == LogLevel.Fatal" foregroundColor="White" backgroundColor="DarkRed" />
		</target>
	</targets>

	<rules>
		<!-- Microsoft 로그 필터링 -->
		<logger name="Microsoft.Hosting.Lifetime" minlevel="Info" writeTo="ConsoleLogger" final="true" />
		<logger name="Microsoft.AspNetCore.Hosting.*" minlevel="Warning" writeTo="FileLogger" final="true" />
		<logger name="Microsoft.EntityFrameworkCore.*" minlevel="Warning" writeTo="FileLogger" final="true" />
		<logger name="Microsoft.*" maxlevel="Info" final="true" />

		<!-- System 로그 필터링 -->
		<logger name="System.Net.Http.*" maxlevel="Info" final="true" />

		<!-- Error 이상은 에러 파일에도 기록 -->
		<logger name="*" minlevel="Error" writeTo="ErrorFileLogger" />

		<!-- 모든 로그 -->
		<logger name="*" minlevel="Debug" writeTo="FileLogger,ConsoleLogger" />
	</rules>
</nlog>
